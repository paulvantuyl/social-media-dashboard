<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create and Manage Posts</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>

  <body>
    <header>
      <button id="logoutBtn" onclick="logout()">Logout</button>
    </header>

    <h1>Create and Manage Posts</h1>

    <div class="post-form">
      <label for="text">Create a new post:</label>
      <textarea id="text" name="text" rows="4" required></textarea>
      <button onclick="createPost()">Create Post</button>
    </div>

    <div class="post-list" id="postList"></div>
    <div class="pagination" id="pagination"></div>

    <script>
      const postsPerPage = 3;
      let currentPage = 1;

      // On page load, fetch the posts
      document.addEventListener('DOMContentLoaded', () => {
        getPosts();
      });

      // Create a new post
      async function createPost() {
        const text = document.getElementById('text').value;
        if (!text) return alert('Post text cannot be empty');

        try {
          const response = await fetch('/post', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text }),
          });
          const data = await response.json();
          if (response.ok) {
            document.getElementById('text').value = '';
            currentPage = 1; // Reset to first page after new post
            getPosts(); // Refresh list
          } else {
            alert(data.message);
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error creating post');
        }
      }

      // Fetch posts from the server
      async function getPosts() {
        try {
          const response = await fetch('/posts', { method: 'GET' });
          const data = await response.json();
          if (response.ok) {
            renderPosts(data.posts);
          } else {
            console.error(data.message);
          }
        } catch (error) {
          console.error('Error:', error);
        }
      }

      // Render the posts into the DOM with pagination
      function renderPosts(posts) {
        const postList = document.getElementById('postList');
        const pagination = document.getElementById('pagination');
        postList.innerHTML = '';

        if (posts.length === 0) {
          postList.innerHTML = '<p>No posts available.</p>';
          pagination.innerHTML = '';
          return;
        }

        // Calculate slice indices for the current page
        const startIndex = (currentPage - 1) * postsPerPage;
        const endIndex = startIndex + postsPerPage;
        const paginatedPosts = posts.slice(startIndex, endIndex);

        // Render posts for the current page
        paginatedPosts.forEach((post) => {
          const postDiv = document.createElement('div');
          postDiv.className = 'post';

          const postText = document.createElement('div');
          postText.className = 'post-text';
          postText.textContent = post.text;

          // Edit button
          const editButton = document.createElement('button');
          editButton.textContent = 'Edit';
          editButton.className = 'edit-post-btn';
          editButton.onclick = () => editPost(post);

          // Delete button
          const deleteButton = document.createElement('button');
          deleteButton.textContent = 'Delete';
          deleteButton.className = 'delete-post-btn';
          deleteButton.onclick = () => deletePost(post._id);

          postDiv.appendChild(postText);
          postDiv.appendChild(editButton);
          postDiv.appendChild(deleteButton);
          postList.appendChild(postDiv);
        });

        // Create pagination buttons
        const totalPages = Math.ceil(posts.length / postsPerPage);
        pagination.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
          const pageButton = document.createElement('button');
          pageButton.textContent = i;
          pageButton.onclick = () => {
            currentPage = i;
            renderPosts(posts);
          };
          // Highlight the active page button
          if (i === currentPage) {
            pageButton.style.fontWeight = 'bold';
          }
          pagination.appendChild(pageButton);
        }
      }

      // Prompt for editing and then update the post
      function editPost(post) {
        const newText = prompt('Edit your post:', post.text);
        if (newText !== null && newText !== post.text) {
          updatePost(post._id, newText);
        }
      }

      // Update a post via the API
      async function updatePost(postId, text) {
        try {
          const response = await fetch(`/posts/${postId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text }),
          });
          const data = await response.json();
          if (response.ok) {
            getPosts(); // Refresh list
          } else {
            alert(data.message);
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error updating post');
        }
      }

      // Delete a post via the API
      async function deletePost(postId) {
        try {
          const response = await fetch(`/posts/${postId}`, {
            method: 'DELETE',
          });
          const data = await response.json();
          if (response.ok) {
            getPosts();
          } else {
            alert(data.message);
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error deleting post');
        }
      }

      // Logout by redirecting to the logout endpoint
      function logout() {
        window.location.href = '/logout';
      }
    </script>
  </body>
</html>
